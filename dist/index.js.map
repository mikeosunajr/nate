{
  "version": 3,
  "sources": ["../binaryen.js", "../src/core.ts", "../src/index.ts"],
  "sourcesContent": ["import binaryen from 'https://cdn.jsdelivr.net/npm/binaryen@105.0.0/index.min.js'\n\nexport default binaryen", "export enum Kind {\n  add,\n  number,\n}\n\nexport enum TypeKinds {\n  number,\n}\n\nexport class TNumber {\n  kind: TypeKinds.number = TypeKinds.number;\n}\n\nexport type Type = TNumber;\n\nclass AddWord {\n  kind: Kind.add = Kind.add;\n}\n\nclass NumberWord {\n  kind: Kind.number = Kind.number;\n  number: number;\n  constructor(n: number) {\n    this.number = n;\n  }\n}\n\nexport type Word = AddWord | NumberWord;\n\nexport function Add(): AddWord {\n  return new AddWord();\n}\n\nexport function Number(n: number): NumberWord {\n  return new NumberWord(n);\n}\n\nexport function NumberT(): TNumber {\n  return new TNumber();\n}\n", "import binaryen from \"binaryen\";\nimport * as Core from \"./core\";\n\nlet memory = new WebAssembly.Memory({\n  initial: 10,\n  maximum: 100,\n  shared: true,\n});\n\nfunction compile(params: Core.Type[], words: Core.Word[]) {\n  var mod = new binaryen.Module();\n\n  const stack: Array<number> = [];\n  const vars: Array<Core.Type> = [];\n\n  let varId = 0;\n  const use = () => {\n    if (stack.length < 1) {\n      throw new Error(\"popping empty stack\");\n    }\n    return stack.pop() || 0;\n  };\n  const genvar = (t: Core.Type) => {\n    stack.push(varId);\n    vars.push(t);\n    varId += 1;\n    return varId - 1;\n  };\n\n  params.forEach((p) => {\n    genvar(p);\n  });\n\n  const expressions = words.map((word) => {\n    switch (word.kind) {\n      case Core.Kind.add:\n        // return add of last 2 values of stack\n        const a = mod.local.get(use(), binaryen.i32);\n        const b = mod.local.get(use(), binaryen.i32);\n\n        return mod.local.set(genvar(Core.NumberT()), mod.i32.add(a, b));\n      case Core.Kind.number:\n        // Push const value to stack\n        return mod.local.set(\n          genvar(Core.NumberT()),\n          mod.i32.const(word.number)\n        );\n    }\n  });\n\n  const varsToBinaryenTypes = () => vars.map((v) => binaryen.i32);\n\n  mod.addFunction(\n    \"run\",\n    binaryen.createType([binaryen.i32]),\n    binaryen.i32,\n    varsToBinaryenTypes(),\n    mod.block(null, [\n      ...expressions,\n      mod.return(mod.local.get(use(), binaryen.i32)),\n    ])\n  );\n\n  mod.addFunctionExport(\"run\", \"run\");\n  mod.addMemoryImport(\"0\", \"env\", \"memory\");\n  mod.setMemory(1, 256, \"memoryExport\", [], true);\n  mod.setFeatures(binaryen.Features.Atomics);\n\n  // Optimize the module using default passes and levels\n  //mod.optimize();\n\n  // // // Validate the module\n  if (!mod.validate()) throw new Error(\"validation error\");\n\n  // // Generate text format and binary\n  var textData = mod.emitText();\n  console.log(textData);\n  var wasmData = mod.emitBinary();\n\n  // Example usage with the WebAssembly API\n  return new WebAssembly.Module(wasmData);\n}\n\nconst wasm = compile(\n  [Core.NumberT()],\n  [\n    Core.Number(3),\n    Core.Number(3),\n    Core.Add(),\n    Core.Add(),\n    Core.Number(3),\n    Core.Add(),\n  ]\n);\n\nvar instance = new WebAssembly.Instance(wasm, { env: { memory } });\nconsole.log((instance.exports.run as CallableFunction)(1));\n\n//addOne(42); // => 43\n"],
  "mappings": ";AAAA;AAEA,IAAO,mBAAQ;;;ACOR,oBAAc;AAAA,EAAd,cATP;AAUE,gBAAyB;AAAA;AAAA;AAK3B,oBAAc;AAAA,EAAd,cAfA;AAgBE,gBAAiB;AAAA;AAAA;AAGnB,uBAAiB;AAAA,EAGf,YAAY,GAAW;AAFvB,gBAAoB;AAGlB,SAAK,SAAS;AAAA;AAAA;AAMX,eAAwB;AAC7B,SAAO,IAAI;AAAA;AAGN,gBAAgB,GAAuB;AAC5C,SAAO,IAAI,WAAW;AAAA;AAGjB,mBAA4B;AACjC,SAAO,IAAI;AAAA;;;ACnCb,IAAI,SAAS,IAAI,YAAY,OAAO;AAAA,EAClC,SAAS;AAAA,EACT,SAAS;AAAA,EACT,QAAQ;AAAA;AAGV,iBAAiB,QAAqB,OAAoB;AACxD,MAAI,MAAM,IAAI,iBAAS;AAEvB,QAAM,QAAuB;AAC7B,QAAM,OAAyB;AAE/B,MAAI,QAAQ;AACZ,QAAM,MAAM,MAAM;AAChB,QAAI,MAAM,SAAS,GAAG;AACpB,YAAM,IAAI,MAAM;AAAA;AAElB,WAAO,MAAM,SAAS;AAAA;AAExB,QAAM,SAAS,CAAC,MAAiB;AAC/B,UAAM,KAAK;AACX,SAAK,KAAK;AACV,aAAS;AACT,WAAO,QAAQ;AAAA;AAGjB,SAAO,QAAQ,CAAC,MAAM;AACpB,WAAO;AAAA;AAGT,QAAM,cAAc,MAAM,IAAI,CAAC,SAAS;AACtC,YAAQ,KAAK;AAAA,WACN;AAEH,cAAM,IAAI,IAAI,MAAM,IAAI,OAAO,iBAAS;AACxC,cAAM,IAAI,IAAI,MAAM,IAAI,OAAO,iBAAS;AAExC,eAAO,IAAI,MAAM,IAAI,OAAO,AAAK,YAAY,IAAI,IAAI,IAAI,GAAG;AAAA,WACzD;AAEH,eAAO,IAAI,MAAM,IACf,OAAO,AAAK,YACZ,IAAI,IAAI,MAAM,KAAK;AAAA;AAAA;AAK3B,QAAM,sBAAsB,MAAM,KAAK,IAAI,CAAC,MAAM,iBAAS;AAE3D,MAAI,YACF,OACA,iBAAS,WAAW,CAAC,iBAAS,OAC9B,iBAAS,KACT,uBACA,IAAI,MAAM,MAAM;AAAA,IACd,GAAG;AAAA,IACH,IAAI,OAAO,IAAI,MAAM,IAAI,OAAO,iBAAS;AAAA;AAI7C,MAAI,kBAAkB,OAAO;AAC7B,MAAI,gBAAgB,KAAK,OAAO;AAChC,MAAI,UAAU,GAAG,KAAK,gBAAgB,IAAI;AAC1C,MAAI,YAAY,iBAAS,SAAS;AAMlC,MAAI,CAAC,IAAI;AAAY,UAAM,IAAI,MAAM;AAGrC,MAAI,WAAW,IAAI;AACnB,UAAQ,IAAI;AACZ,MAAI,WAAW,IAAI;AAGnB,SAAO,IAAI,YAAY,OAAO;AAAA;AAGhC,IAAM,OAAO,QACX,CAAC,AAAK,YACN;AAAA,EACE,AAAK,OAAO;AAAA,EACZ,AAAK,OAAO;AAAA,EACZ,AAAK;AAAA,EACL,AAAK;AAAA,EACL,AAAK,OAAO;AAAA,EACZ,AAAK;AAAA;AAIT,IAAI,WAAW,IAAI,YAAY,SAAS,MAAM,EAAE,KAAK,EAAE;AACvD,QAAQ,IAAK,SAAS,QAAQ,IAAyB;",
  "names": []
}
